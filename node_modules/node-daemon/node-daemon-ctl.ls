require! { \optionator \util \net }

cmd = "node-daemon-ctl"
version = "0.0.1"

opts = optionator do
  prepend: "Usage: #{cmd} [options] {status|fullstatus|start|stop|restart|reload}"
  append: "Version #{version}"
  
  options:
    * option: \socket
      alias:  \s
      type:   \String
      description: "Path to controlling socket"
      default: "./node-daemon.socket"
        
    * option: \help
      alias: \h
      type: \Boolean

cl-options = opts.parse process.argv

command = cl-options._.join " "

if cl-options.help? or /^$/.test command
  console.log opts.generate-help!
  process.exit 0

exec = (cmd) ->
  socket = (new net.Socket)
    .on \error (err) ->
      message = switch err.code
        | \ENOENT => "No such file. Wrong file name or daemon not runing."
        | \ECONNREFUSED => "Connection refused. The daemon must have died."
        | _ => err
      console.log message
      process.exit 1
    .on \data (data) ->
      process.stdout.write data.to-string!
    .on \end ->
      process.exit 0
    .connect cl-options.socket
    .write cmd

switch command
  | \start \restart => console.log "Command `#{command}` not implemented yet"
  | \fullstatus => exec \fullstatus
  | \status  => exec \status
  | \stop    => exec \exit
  | \reload  => exec \reload
  | \gc => exec \gc
  | _ => console.log "Unknown command `#{command}`"